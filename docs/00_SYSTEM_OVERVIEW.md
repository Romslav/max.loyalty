# üåê 00 ‚Äî System Overview: Max Loyalty

> **–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
> **–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–±–æ—Ç–µ  
> **–°–µ—Å—Å–∏—è:** –°-002  

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ß—Ç–æ —Ç–∞–∫–æ–µ Max Loyalty](#1-—á—Ç–æ-—Ç–∞–∫–æ–µ-max-loyalty)
2. [–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ–±–ª–µ–º–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ](#2-–±–∏–∑–Ω–µ—Å-–ø—Ä–æ–±–ª–µ–º–∞-–∏-—Ä–µ—à–µ–Ω–∏–µ)
3. [–†–æ–ª–∏ —Å–∏—Å—Ç–µ–º—ã](#3-—Ä–æ–ª–∏-—Å–∏—Å—Ç–µ–º—ã)
4. [–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã](#4-—Ç–∞—Ä–∏—Ñ–Ω—ã–µ-–ø–ª–∞–Ω—ã)
5. [–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏](#5-–∫–ª—é—á–µ–≤—ã–µ-–∫–æ–Ω—Ü–µ–ø—Ü–∏–∏-–ª–æ—è–ª—å–Ω–æ—Å—Ç–∏)
6. [Multi-tenancy –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#6-multi-tenancy-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
7. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#7-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
8. [–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—É—Ç–∏](#8-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ-–ø—É—Ç–∏)
9. [–ö–ª—é—á–µ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#9-–∫–ª—é—á–µ–≤—ã–µ-–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
10. [–ì–ª–æ—Å—Å–∞—Ä–∏–π](#10-–≥–ª–æ—Å—Å–∞—Ä–∏–π)

---

## 1. –ß—Ç–æ —Ç–∞–∫–æ–µ Max Loyalty

**Max Loyalty** ‚Äî –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è (multi-tenant) SaaS-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–µ—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤.  
–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω–æ–º—É –±–∏–∑–Ω–µ—Å—É –ª—é–±–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ ‚Äî –æ—Ç –æ–¥–Ω–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è –¥–æ –∫—Ä—É–ø–Ω–æ–π —Å–µ—Ç–∏ ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –±–µ–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –Ω—É–ª—è.

### –ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

- **Multi-tenant Pooled** ‚Äî –µ–¥–∏–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (tenants), –∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `tenantId`
- **White-label** ‚Äî –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –¥–∏–∑–∞–π–Ω –∫–∞—Ä—Ç—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥ —Å–µ–±—è
- **SaaS-–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è** ‚Äî 6 —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ –æ—Ç FREE –¥–æ CUSTOM
- **POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ‚Äî –Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã –¥–ª—è iiko Front, R-Keeper, AirKeeper
- **Telegram-first** ‚Äî –≥–æ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Telegram Bot + Mini App
- **RBAC** ‚Äî –ø—è—Ç—å —Ä–æ–ª–µ–π —Å –≥—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
- **–ü–æ–ª–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** ‚Äî 4 —É—Ä–æ–≤–Ω—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ (–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ / —Ä–µ—Å—Ç–æ—Ä–∞–Ω / –º–µ–Ω–µ–¥–∂–µ—Ä / –≥–æ—Å—Ç—å)

### –î–ª—è –∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω –ø—Ä–æ–¥—É–∫—Ç

| –ê—É–¥–∏—Ç–æ—Ä–∏—è | –¶–µ–Ω–Ω–æ—Å—Ç—å |
|---|---|
| **–í–ª–∞–¥–µ–ª–µ—Ü —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (Owner)** | –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –±–∏–ª–ª–∏–Ω–≥–æ–º, –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã |
| **–í–ª–∞–¥–µ–ª–µ—Ü/–¥–∏—Ä–µ–∫—Ç–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (RestaurantAdmin)** | –ü–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥ –∫–ª—é—á |
| **–ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞** | –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—è–º–∏ –∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å—é –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏–π |
| **–ö–∞—Å—Å–∏—Ä** | –ë—ã—Å—Ç—Ä–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ —á–µ—Ä–µ–∑ touch-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å |
| **–ì–æ—Å—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞** | –£–¥–æ–±–Ω–∞—è –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –≤ Telegram, –±–µ–∑ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π |

---

## 2. –ë–∏–∑–Ω–µ—Å-–ø—Ä–æ–±–ª–µ–º–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞ —Ä—ã–Ω–∫–∞

–†–µ—Å—Ç–æ—Ä–∞–Ω—ã —Ç–µ—Ä—è—é—Ç –¥–æ **60‚Äì70% –≥–æ—Å—Ç–µ–π** –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞. –ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–æ–∏—Ç –¥–æ—Ä–æ–≥–æ:  
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: **500k‚Äì5M —Ä—É–±.**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞—Å—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π: **200k‚Äì500k —Ä—É–±.**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: **–æ—Ç 100k —Ä—É–±./–≥–æ–¥**

–ì–æ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ª–∏–±–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∫–∞—Å—Å–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã (iiko, R-Keeper), –ª–∏–±–æ –Ω–µ –∏–º–µ—é—Ç Telegram-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –ª–∏–±–æ —Å–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–∏–µ –¥–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞.

### –†–µ—à–µ–Ω–∏–µ Max Loyalty

```
–†–µ—Å—Ç–æ—Ä–∞–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ 20 –º–∏–Ω—É—Ç:
1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ ‚Üí –æ–ø–ª–∞—Ç–∞
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (drag-and-drop builder)
3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Å—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã (–ø–ª–∞–≥–∏–Ω + 5 –º–∏–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
4. –ü—Ä–∏–≤—è–∑–∫–∞ Telegram-–±–æ—Ç–∞ –∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É
5. –ì–æ—Å—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è: QR-–∫–æ–¥ / –∫–∞—Å—Å–∏—Ä / Telegram
```

### –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –ø–ª–∞–≥–∏–Ω–∞–º–∏ –¥–ª—è iiko + R-Keeper –≤ Telegram-—ç–∫–æ—Å–∏—Å—Ç–µ–º–µ
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫** ‚Äî –Ω–µ—Ç –Ω—É–∂–¥—ã –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∫–æ–º–∞–Ω–¥–µ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- **–ì–∏–±–∫–∏–µ —Ç–∞—Ä–∏—Ñ—ã** ‚Äî –æ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ
- **–†–æ—Å—Å–∏–π—Å–∫–∏–π —Å—Ç–µ–∫ –ø–ª–∞—Ç–µ–∂–µ–π** ‚Äî YooKassa, CloudPayments, CryptoCloud
- **GDPR + 152-–§–ó** ‚Äî –∑–∞—â–∏—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ—Ä–æ–±–∫–∏

---

## 3. –†–æ–ª–∏ —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç **5 —Ä–æ–ª–µ–π** —Å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–º RBAC –∏ fine-grained permissions.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          OWNER                              ‚îÇ
‚îÇ   –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π (–≤—Å–µ —Ç–µ–Ω–∞–Ω—Ç—ã, –±–∏–ª–ª–∏–Ω–≥, KPI)    ‚îÇ
‚îÇ   –ú–æ–∂–µ—Ç impersonate –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ —Å–æ–∑–¥–∞—ë—Ç
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   RESTAURANT ADMIN                          ‚îÇ
‚îÇ   –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ–¥–Ω–∏–º —Ç–µ–Ω–∞–Ω—Ç–æ–º (tenant = —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç)  ‚îÇ
‚îÇ   –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç loyalty rules, —É—Ä–æ–≤–Ω–∏, –ø—Ä–æ–º–æ, –¥–∏–∑–∞–π–Ω –∫–∞—Ä—Ç—ã   ‚îÇ
‚îÇ   –í–∏–¥–∏—Ç –ø–æ–ª–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Å–≤–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞                  ‚îÇ
‚îÇ   –£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥–æ–π: —Å–æ–∑–¥–∞—ë—Ç Manager/Cashier –∞–∫–∫–∞—É–Ω—Ç—ã     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ —Å–æ–∑–¥–∞—ë—Ç                   ‚îÇ —Å–æ–∑–¥–∞—ë—Ç
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    MANAGER       ‚îÇ    ‚îÇ           CASHIER                    ‚îÇ
‚îÇ  –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ    ‚îÇ    ‚îÇ  –ö–∞—Å—Å–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (POS)            ‚îÇ
‚îÇ  —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ      ‚îÇ    ‚îÇ  pos.maxloyalty.app                  ‚îÇ
‚îÇ  –†—É—á–Ω–∞—è          ‚îÇ    ‚îÇ  Earn / Redeem –±–∞–ª–ª–æ–≤                ‚îÇ
‚îÇ  –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞   ‚îÇ    ‚îÇ  –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π            ‚îÇ
‚îÇ  –±–∞–ª–ª–æ–≤          ‚îÇ    ‚îÇ  PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è                     ‚îÇ
‚îÇ  (—Å –ø—Ä–∏—á–∏–Ω–æ–π)    ‚îÇ    ‚îÇ  Offline-—Ä–µ–∂–∏–º (IndexedDB)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          GUEST                               ‚îÇ
‚îÇ  Telegram Mini App ‚Äî –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏                        ‚îÇ
‚îÇ  –í–∏–¥–∏—Ç: –±–∞–ª–∞–Ω—Å, –∏—Å—Ç–æ—Ä–∏—é, QR-–∫–æ–¥, —É—Ä–æ–≤–µ–Ω—å, –ø—Ä–æ–º–æ              ‚îÇ
‚îÇ  3 —Å–ø–æ—Å–æ–±–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: –∫–∞—Å—Å–∞ / QR-—Å—Å—ã–ª–∫–∞ / Telegram-–±–æ—Ç     ‚îÇ
‚îÇ  –ù–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–µ–±-–ø–∞–Ω–µ–ª–∏                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –î–µ—Ç–∞–ª—å–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤ (RBAC Permissions)

| Permission | Owner | RestaurantAdmin | Manager | Cashier | Guest |
|---|:---:|:---:|:---:|:---:|:---:|
| `create:guest` | ‚úÖ | ‚úÖ (own) | ‚úÖ (own) | ‚úÖ | ‚Äî |
| `read:guest` | ‚úÖ all | ‚úÖ own | ‚úÖ own | ‚úÖ basic | self |
| `read:guest_analytics` | ‚úÖ | ‚úÖ | ‚úÖ | ‚Äî | ‚Äî |
| `manage:balls_manual` | ‚úÖ | ‚úÖ | ‚úÖ | ‚Äî | ‚Äî |
| `manage:balls_pos` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚Äî |
| `manage:loyalty_system` | ‚úÖ | ‚úÖ | ‚Äî | ‚Äî | ‚Äî |
| `manage:loyalty_design` | ‚úÖ | ‚úÖ | ‚Äî | ‚Äî | ‚Äî |
| `manage:loyalty_promo` | ‚úÖ | ‚úÖ | ‚Äî | ‚Äî | ‚Äî |
| `manage:restaurants` | ‚úÖ | ‚úÖ own | ‚Äî | ‚Äî | ‚Äî |
| `manage:users` | ‚úÖ | ‚úÖ (own) | ‚Äî | ‚Äî | ‚Äî |
| `manage:permissions` | ‚úÖ | ‚úÖ (own) | ‚Äî | ‚Äî | ‚Äî |
| `create:manager` | ‚úÖ | ‚úÖ | ‚Äî | ‚Äî | ‚Äî |
| `create:cashier` | ‚úÖ | ‚úÖ | ‚úÖ | ‚Äî | ‚Äî |
| `read:analytics_all` | ‚úÖ | ‚úÖ own | ‚úÖ own | ‚Äî | ‚Äî |
| `impersonate` | ‚úÖ | ‚Äî | ‚Äî | ‚Äî | ‚Äî |
| `edit:profile` | ‚Äî | ‚Äî | ‚Äî | ‚Äî | self |
| `view:card` | ‚Äî | ‚Äî | ‚Äî | ‚Äî | own |

> **Dynamic Permissions:** Admin –º–æ–∂–µ—Ç –≥–∏–±–∫–æ –Ω–∞–∑–Ω–∞—á–∞—Ç—å/–æ—Ç–∑—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ permissions –¥–ª—è Manager –∏ Cashier —Å–≤–µ—Ä—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π (—á–µ—Ä–µ–∑ `UserPermission` —Ç–∞–±–ª–∏—Ü—É).

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–æ–ª–µ–π

**OWNER:**
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é `OwnerRegistrationLink` (–Ω–µ —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—É—é —Ñ–æ—Ä–º—É)
- –ú–æ–∂–µ—Ç impersonate –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ 2 —á–∞—Å–∞ (—Å –ø–æ–ª–Ω—ã–º audit trail)
- –í–∏–¥–∏—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É: MRR, ARR, Churn, ARPU, LTV –ø–æ –≤—Å–µ–º —Ç–µ–Ω–∞–Ω—Ç–∞–º
- –£–ø—Ä–∞–≤–ª—è–µ—Ç subscriptions –∏ billing –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

**RESTAURANT ADMIN:**
- –ü—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É `tenantId` (tenant = —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –ø–æ–¥–ø–∏—Å–∫–æ–π)
- –í –æ–¥–Ω–æ–º tenant –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∞—Ä–∏—Ñ–∞)
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏: rules, levels, promos, card design
- –í—ã–±–∏—Ä–∞–µ—Ç —Ç–∏–ø —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏: UNIFIED –∏–ª–∏ SEPARATE
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ Admins –≤ –æ–¥–Ω–æ–º tenant

**MANAGER:**
- –ù–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è Admin –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- –†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –±–∞–ª–ª–æ–≤ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å –ø—Ä–∏—á–∏–Ω–æ–π** (audit trail)
- –ú–∞–∫—Å–∏–º—É–º ¬±10,000 –±–∞–ª–ª–æ–≤ –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é (Admin –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç)
- –í–∏–¥–∏—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Å–≤–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –Ω–µ –≤–∏–¥–∏—Ç billing

**CASHIER:**
- PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (4 —Ü–∏—Ñ—Ä—ã) –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ/–ü–ö –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
- –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ `pos.maxloyalty.app` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ PWA
- –¢–æ–ª—å–∫–æ Earn/Redeem –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π
- Offline-—Ä–µ–∂–∏–º: –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ IndexedDB, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–∏

**GUEST:**
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ **—Ç–µ–ª–µ—Ñ–æ–Ω** (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á) + Telegram ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `GuestProfile` —Ö—Ä–∞–Ω–∏—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- `GuestCard` —Ö—Ä–∞–Ω–∏—Ç –±–∞–ª–∞–Ω—Å (regular + promo), —É—Ä–æ–≤–µ–Ω—å, QR-–∫–æ–¥, 6-digit display code
- –î–µ—Ç–∏ (`GuestChild`) ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –ø—Ä–æ—Ñ–∏–ª—é –≥–æ—Å—Ç—è (–¥–ª—è –¥–µ—Ç—Å–∫–∏—Ö –ø—Ä–æ–º–æ)

---

## 4. –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

Max Loyalty –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç **6 —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤**. –¢–∞—Ä–∏—Ñ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `Subscription` —Ç–µ–Ω–∞–Ω—Ç–∞ –∏ –≤–ª–∏—è–µ—Ç –Ω–∞ –ª–∏–º–∏—Ç—ã —á–µ—Ä–µ–∑ `TenantLimits`.

| –¢–∞—Ä–∏—Ñ | –†–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ | –ì–æ—Å—Ç–µ–π | –ú–µ—Å—è—Ü (—Ä—É–±.) | –ì–æ–¥ (—Ä—É–±./–º–µ—Å) | –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ |
|---|:---:|:---:|:---:|:---:|---|
| **FREE** | 1 | 100 | 0 | 0 | –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç–æ–ª—å–∫–æ –∫–∞—Å—Å–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –±–µ–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ |
| **STANDARD** | 1 | 500 | 5,000 | 4,000 | +Telegram-–±–æ—Ç, –±–∞–∑–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, 1 –ø—Ä–æ–º–æ |
| **MEDIUM** | 3 | 2,000 | 15,000 | 12,000 | +POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, 5 –ø—Ä–æ–º–æ |
| **PRO** | 5 | 6,000 | 35,000 | 28,000 | +API-–¥–æ—Å—Ç—É–ø, —ç–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤, 20 –ø—Ä–æ–º–æ, SLA |
| **ULTIMATE** | ‚àû | ‚àû | 100,000 | 80,000 | –í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| **CUSTOM** | –ü–æ –¥–æ–≥–æ–≤–æ—Ä—É | –ü–æ –¥–æ–≥–æ–≤–æ—Ä—É | –ü–æ –¥–æ–≥–æ–≤–æ—Ä—É | –ü–æ –¥–æ–≥–æ–≤–æ—Ä—É | Enterprise, on-premise –æ–ø—Ü–∏—è, SLA 99.9% |

> **–°–∫–∏–¥–∫–∞ 20%** –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥ (–∫–ª—é—á–µ–≤–æ–π —Å—Ç–∏–º—É–ª –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞).  
> **Trial:** 14 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ –ª—é–±–æ–º —Ç–∞—Ä–∏—Ñ–µ (–∫—Ä–æ–º–µ CUSTOM).  
> **Grace period:** 90 –¥–Ω–µ–π –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã.  

### –ú–µ—Ö–∞–Ω–∏–∑–º –ª–∏–º–∏—Ç–æ–≤

```typescript
// TenantLimits ‚Äî –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞—ë—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞—Ä–∏—Ñ–∞
interface TenantLimits {
  tenantId: string;
  maxRestaurants: number;        // –õ–∏–º–∏—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
  maxGuests: number;             // –õ–∏–º–∏—Ç –≥–æ—Å—Ç–µ–π
  maxPromos: number;             // –õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–π
  allowPosIntegration: boolean;  // –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
  allowTelegramBot: boolean;     // –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram-–±–æ—Ç–∞
  allowApiAccess: boolean;       // –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–µ–≥–æ API
  allowExportReports: boolean;   // –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç—á—ë—Ç–æ–≤
  allowAdvancedAnalytics: boolean; // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
  allowCustomCardDesign: boolean;  // –ö–∞—Å—Ç–æ–º–Ω—ã–π –¥–∏–∑–∞–π–Ω –∫–∞—Ä—Ç—ã
}
```

### Billing flow

```
Admin —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
    ‚Üì
–û–±—ä–µ–∫—Ç Tenant —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º TRIAL (14 –¥–Ω–µ–π)
    ‚Üì
Admin –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ ‚Üí –°–æ–∑–¥–∞—ë—Ç—Å—è Invoice
    ‚Üì
–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ YooKassa / Stripe / CloudPayments / CryptoCloud
    ‚Üì
Subscription.status = ACTIVE, TenantLimits –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
    ‚Üì (–ø—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ)
    ‚îú‚îÄ Day 0: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏
    ‚îú‚îÄ Day 1: –°—Ç–∞—Ç—É—Å PAST_DUE, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    ‚îú‚îÄ Day 3: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    ‚îú‚îÄ Day 7: CANCELLED_NONPAYMENT, —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã
    ‚îî‚îÄ Day 97 (grace period –∏—Å—Ç—ë–∫): –î–∞–Ω–Ω—ã–µ –ø–æ–º–µ—á–µ–Ω—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
```

---

## 5. –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

### 5.1 –¢–∏–ø —Å–∏—Å—Ç–µ–º—ã: POINTS vs DISCOUNT

| | POINTS | DISCOUNT |
|---|---|---|
| **–ú–µ—Ö–∞–Ω–∏–∫–∞** | –ì–æ—Å—Ç—å –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç ¬´–±–∞–ª–ª—ã¬ª (1 –±–∞–ª–ª = 1 —Ä—É–±.) | –ì–æ—Å—Ç—å –ø–æ–ª—É—á–∞–µ—Ç —Å–∫–∏–¥–∫—É –≤ % –Ω–∞ —á–µ–∫ |
| **–ú–æ—Ç–∏–≤–∞—Ü–∏—è** | –ù–∞–∫–æ–ø–∏—Ç—å –∏ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –≤ —Å–ª–µ–¥—É—é—â–∏–π –≤–∏–∑–∏—Ç | –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –≤—ã–≥–æ–¥–∞ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å |
| **–ì–∏–±–∫–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è: —Ä–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞, —É—Ä–æ–≤–Ω–∏, –ø—Ä–æ–º–æ | –°—Ä–µ–¥–Ω—è—è: —Å–∫–∏–¥–æ—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ |
| **–•—Ä–∞–Ω–µ–Ω–∏–µ** | `GuestCard.regularBalance + promoBalance` | `GuestCard.discountPercent` |
| **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ** | Admin –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ LoyaltySystem | ‚Äî |

### 5.2 –†–µ–∂–∏–º –∫–∞—Ä—Ç—ã: UNIFIED vs SEPARATE

–ö–ª—é—á–µ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –¥–ª—è —Å–µ—Ç–µ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤:

```
UNIFIED —Ä–µ–∂–∏–º:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –û–¥–∏–Ω –≥–æ—Å—Ç—å ‚Üí –û–¥–Ω–∞ –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ–π —Å–µ—Ç–∏          ‚îÇ
‚îÇ  –†–µ—Å—Ç–æ—Ä–∞–Ω A: –∑–∞—Ä–∞–±–æ—Ç–∞–ª 200 –±–∞–ª–ª–æ–≤                          ‚îÇ
‚îÇ  –†–µ—Å—Ç–æ—Ä–∞–Ω B: –∑–∞—Ä–∞–±–æ—Ç–∞–ª 150 –±–∞–ª–ª–æ–≤          ‚Üì               ‚îÇ
‚îÇ  –†–µ—Å—Ç–æ—Ä–∞–Ω C: –∑–∞—Ä–∞–±–æ—Ç–∞–ª 300 –±–∞–ª–ª–æ–≤  ‚Üí  –ò—Ç–æ–≥–æ: 650 –±–∞–ª–ª–æ–≤   ‚îÇ
‚îÇ  –ü–æ—Ç—Ä–∞—Ç–∏—Ç—å –º–æ–∂–Ω–æ –≤ –ª—é–±–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ —Å–µ—Ç–∏                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

SEPARATE —Ä–µ–∂–∏–º:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –û–¥–∏–Ω –≥–æ—Å—Ç—å ‚Üí –û—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –≤ –∫–∞–∂–¥–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ           ‚îÇ
‚îÇ  –ö–∞—Ä—Ç–∞ –†–µ—Å—Ç–æ—Ä–∞–Ω–∞ A: 200 –±–∞–ª–ª–æ–≤ (—Ç—Ä–∞—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å)      ‚îÇ
‚îÇ  –ö–∞—Ä—Ç–∞ –†–µ—Å—Ç–æ—Ä–∞–Ω–∞ B: 150 –±–∞–ª–ª–æ–≤ (—Ç—Ä–∞—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å)      ‚îÇ
‚îÇ  –ö–∞—Ä—Ç–∞ –†–µ—Å—Ç–æ—Ä–∞–Ω–∞ C: 300 –±–∞–ª–ª–æ–≤ (—Ç—Ä–∞—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ú–∏–≥—Ä–∞—Ü–∏—è UNIFIED ‚Üî SEPARATE:**
- SEPARATE ‚Üí UNIFIED: –≤–æ–∑–º–æ–∂–Ω–∞, –±–∞–ª–ª—ã —Å—É–º–º–∏—Ä—É—é—Ç—Å—è, —Å—Ç–∞—Ç—É—Å `MIGRATED`
- UNIFIED ‚Üí SEPARATE: –≤–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Ä–µ–¥–∏–∑–∞–π–Ω–µ —Å–∏—Å—Ç–µ–º—ã (admin –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç)
- –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ `GuestCard` –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç—Å—è, –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### 5.3 –ë–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è: Regular vs Promo

–õ—é–±–∞—è –∫–∞—Ä—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç **–¥–≤–∞ —Ç–∏–ø–∞ –±–∞–ª–∞–Ω—Å–∞:**

```
GuestCard:
‚îú‚îÄ‚îÄ regularBalance: 2,500   ‚Üê –Ω–∞—á–∏—Å–ª–µ–Ω–æ –∑–∞ –ø–æ–∫—É–ø–∫–∏
‚îî‚îÄ‚îÄ promoBalance:     300   ‚Üê –±–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã –æ—Ç –ø—Ä–æ–º–æ (–∏–º–µ—é—Ç —Å—Ä–æ–∫)
    totalBalance:   2,800   ‚Üê —Å—É–º–º–∞ (—á—Ç–æ –≤–∏–¥–∏—Ç –≥–æ—Å—Ç—å)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏:** —Å–Ω–∞—á–∞–ª–∞ `promoBalance` (–¥–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è), –∑–∞—Ç–µ–º `regularBalance`.

**–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:**
- `regularBalance`: –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ N –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (default: 90, Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç)
- `promoBalance`: –∫–∞–∂–¥—ã–π –ø—Ä–æ–º–æ-–≥—Ä–∞–Ω—Ç (`PromoBallGranted`) –∏–º–µ–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π `expiresAt`
- FIFO-–ª–æ–≥–∏–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è: –ø–µ—Ä–≤—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∏—Å—Ç–µ–∫–∞—é—Ç –ø–µ—Ä–≤—ã–º–∏

### 5.4 –£—Ä–æ–≤–Ω–∏ –≥–æ—Å—Ç—è (Levels)

Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —É—Ä–æ–≤–Ω–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. –£—Ä–æ–≤–Ω–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:

```
Bronze  ü•â  –ü–æ—Ä–æ–≥: 0 —Ä—É–±.       –ë–æ–Ω—É—Å –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é: +0%
Silver  ü•à  –ü–æ—Ä–æ–≥: 150,000 —Ä—É–±. –ë–æ–Ω—É—Å –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é: +5%
Gold    ü•á  –ü–æ—Ä–æ–≥: 400,000 —Ä—É–±. –ë–æ–Ω—É—Å –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é: +10%
```

- **One-way up logic** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): —É—Ä–æ–≤–µ–Ω—å —Ç–æ–ª—å–∫–æ –ø–æ–≤—ã—à–∞–µ—Ç—Å—è
- **Downgrade –≤–æ–∑–º–æ–∂–µ–Ω** (–≤–∫–ª—é—á–∞–µ—Ç—Å—è Admin): —á–µ—Ä–µ–∑ 180 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–ª–∏ –Ω–∏–∂–µ 80% –ø–æ—Ä–æ–≥–∞
- –ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π: CRON-–¥–∂–æ–± –≤ 03:00 UTC –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
- Admin –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–Ω–∏: Platinum (1M), Diamond –∏ –¥—Ä.
- –£—Ä–æ–≤–µ–Ω—å –≤–ª–∏—è–µ—Ç –Ω–∞ `earnBonus`: `earned = floor(checkAmount * earnPercent / 100) + floor(checkAmount * earnBonus / 100)`

### 5.5 –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (Loyalty Rules)

```
–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è Admin —á–µ—Ä–µ–∑ Loyalty Builder):

[–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1] Birthday Cashback
  –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ: 15%
  –£—Å–ª–æ–≤–∏–µ: –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –≥–æ—Å—Ç—è (¬± N –¥–Ω–µ–π)
  –°—Ä–æ–∫ –ø—Ä–æ–º–æ-–±–∞–ª–ª–æ–≤: 7 –¥–Ω–µ–π

[–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2] Weekend Bonus  
  –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ: 12%
  –£—Å–ª–æ–≤–∏–µ: —Å—É–±–±–æ—Ç–∞-–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ + —á–µ–∫ –æ—Ç 1,500 —Ä—É–±.

[–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3] Base Cashback
  –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ: 10%
  –£—Å–ª–æ–≤–∏–µ: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —á–µ–∫ –æ—Ç 50 —Ä—É–±. (–≤—Å–µ–≥–¥–∞)
```

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª:**  
–ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é (`LoyaltyRuleVersion`).  
–í—Å–µ `BallTransaction` —Ö—Ä–∞–Ω—è—Ç `ruleSnapshot` (JSON-—Å–Ω–∏–º–æ–∫ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏).  
–≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–ø–æ—Ä–æ–≤: ¬´–º–Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É¬ª.

### 5.6 –ü—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–∏ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–æ–º–æ

–ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–º–æ ‚Äî Admin –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é:

```
COMBINE_ALL:  Birthday(1000) + Wednesday(500) + FirstVisit(1000) = 2,500 –±–∞–ª–ª–æ–≤
MAX_ONLY:     MAX(1000, 500, 1000) = 1,000 –±–∞–ª–ª–æ–≤
FIRST_ONLY:   Birthday (–Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1000) = 1,000 –±–∞–ª–ª–æ–≤
```

Admin –º–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–ª—è **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–∞—Ä –ø—Ä–æ–º–æ** —á–µ—Ä–µ–∑ `conflictRules`.

–¢–∏–ø—ã –ø—Ä–æ–º–æ:
- `BIRTHDAY` ‚Äî –∫–æ –¥–Ω—é —Ä–æ–∂–¥–µ–Ω–∏—è –≥–æ—Å—Ç—è
- `CHILD_BIRTHDAY` ‚Äî –∫–æ –¥–Ω—é —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ–±—ë–Ω–∫–∞ –≥–æ—Å—Ç—è
- `FIRST_VISIT` ‚Äî –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω
- `INACTIVITY` ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ N –¥–Ω–µ–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è
- `CUSTOM` ‚Äî –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è

### 5.7 Earn & Redeem

**EARN (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ):**
```
1. –ö–∞—Å—Å–∏—Ä –≤–≤–æ–¥–∏—Ç —Å—É–º–º—É —á–µ–∫–∞: 2,000 —Ä—É–±.
2. –°–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
3. –ü—Ä–∏–º–µ–Ω—è–µ—Ç —É—Ä–æ–≤–Ω–µ–≤—ã–π –±–æ–Ω—É—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, Silver: +5%)
4. –†–∞—Å—á—ë—Ç: floor(2000 * 10/100) = 200 –±–∞–∑–æ–≤—ã—Ö
             + floor(2000 * 5/100) = 100 —É—Ä–æ–≤–Ω–µ–≤—ã—Ö
             = 300 –±–∞–ª–ª–æ–≤ –ò–¢–û–ì–û
5. –°–æ–∑–¥–∞—ë—Ç—Å—è BallTransaction(type=EARN) + GuestVisit
```

**REDEEM (—Å–ø–∏—Å–∞–Ω–∏–µ):**
```
–ü—Ä–∞–≤–∏–ª–∞:
- minCheckAmount: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞ (default: 50 —Ä—É–±.)
- redeemLimit: –º–∞–∫—Å–∏–º—É–º X% –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞ (default: 20%, Admin: 10-100%)
- –ú–∏–Ω–∏–º—É–º –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è: 10 –±–∞–ª–ª–æ–≤
- –°–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è promoBalance, –ø–æ—Ç–æ–º regularBalance
- –ü–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å –Ω–µ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
```

---

## 6. Multi-tenancy –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–æ–¥–µ–ª—å: Pooled Database

–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã (tenants) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ **–æ–¥–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL**.  
–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–æ–ª–µ `tenantId` –≤ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ.

```sql
-- –ü—Ä–∏–º–µ—Ä: –∫–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç tenantId
CREATE TABLE guest_profiles (
  id          UUID PRIMARY KEY,
  tenant_id   UUID NOT NULL REFERENCES tenants(id),  ‚Üê –∫–ª—é—á –∏–∑–æ–ª—è—Ü–∏–∏
  phone       VARCHAR(20),
  name        VARCHAR(100),
  ...
  INDEX idx_guest_tenant (tenant_id)  ‚Üê –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
);
```

**–ü–æ—á–µ–º—É Pooled, –∞ –Ω–µ Isolated (–æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞)?**

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Pooled ‚úÖ | Isolated |
|---|---|---|
| –°—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã | –ù–∏–∑–∫–∞—è (1 –ë–î) | –í—ã—Å–æ–∫–∞—è (N –ë–î) |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ | –°–ª–æ–∂–Ω–æ–µ |
| –ú–µ–∂—Ç–µ–Ω–∞–Ω—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ | –õ–µ–≥–∫–æ (SQL) | –°–ª–æ–∂–Ω–æ |
| –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | –õ–æ–≥–∏—á–µ—Å–∫–∞—è (tenantId) | –§–∏–∑–∏—á–µ—Å–∫–∞—è |
| –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã | –û–¥–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è | N –º–∏–≥—Ä–∞—Ü–∏–π |
| –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è | –î–æ 10,000 —Ç–µ–Ω–∞–Ω—Ç–æ–≤ | Enterprise, compliance |

### JWT –∏ multi-tenancy

```typescript
// Payload JWT access token (15 –º–∏–Ω—É—Ç)
{
  sub: "user-uuid",
  email: "admin@sushilka.ru",
  role: "RESTAURANT_ADMIN",
  tenantId: "tenant-uuid",          // ‚Üê –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–Ω–∞–Ω—Ç
  tenantIds: ["tenant-1", "tenant-2"], // ‚Üê –¥–ª—è –º—É–ª—å—Ç–∏—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
  permissions: ["manage:loyalty", "read:analytics"],
  iat: 1738000000,
  exp: 1738000900   // +15 –º–∏–Ω—É—Ç
}
```

**TenantGuard** ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–º—É tenantId –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.

### –ò–µ—Ä–∞—Ä—Ö–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π

```
Tenant (–∞–∫–∫–∞—É–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞)
‚îî‚îÄ‚îÄ Subscription (–ø–æ–¥–ø–∏—Å–∫–∞)
‚îî‚îÄ‚îÄ TenantLimits (–ª–∏–º–∏—Ç—ã —Ç–∞—Ä–∏—Ñ–∞)
‚îî‚îÄ‚îÄ Restaurant[] (1..N —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤)
    ‚îî‚îÄ‚îÄ LoyaltySystem (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏)
        ‚îî‚îÄ‚îÄ LoyaltyLevel[] (—É—Ä–æ–≤–Ω–∏)
        ‚îî‚îÄ‚îÄ LoyaltyRule[] (–ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è)
        ‚îî‚îÄ‚îÄ LoyaltyPromo[] (–ø—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–∏)
    ‚îî‚îÄ‚îÄ User[role=MANAGER] (–º–µ–Ω–µ–¥–∂–µ—Ä—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞)
    ‚îî‚îÄ‚îÄ User[role=CASHIER] (–∫–∞—Å—Å–∏—Ä—ã)
    ‚îî‚îÄ‚îÄ GuestCard[] (–∫–∞—Ä—Ç—ã –≥–æ—Å—Ç–µ–π –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º)
‚îî‚îÄ‚îÄ User[role=RESTAURANT_ADMIN] (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∞–∫–∫–∞—É–Ω—Ç–∞)
‚îî‚îÄ‚îÄ GuestProfile[] (–ø—Ä–æ—Ñ–∏–ª–∏ –≥–æ—Å—Ç–µ–π –≤—Å–µ–π —Å–µ—Ç–∏)
    ‚îî‚îÄ‚îÄ GuestCard[] (1..N –∫–∞—Ä—Ç –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö)
    ‚îî‚îÄ‚îÄ GuestChild[] (–¥–µ—Ç–∏ –≥–æ—Å—Ç—è)
    ‚îî‚îÄ‚îÄ BallTransaction[] (–∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
    ‚îî‚îÄ‚îÄ GuestVisit[] (–∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π)
```

---

## 7. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend

```
NestJS 10 + TypeScript 5
‚îú‚îÄ‚îÄ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:  Modular Monolith (‚Üí –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã Phase 2)
‚îú‚îÄ‚îÄ ORM:          Prisma 5 (type-safe, –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞)
‚îú‚îÄ‚îÄ DB:           PostgreSQL 15 (Neon.tech ‚Äî serverless PostgreSQL)
‚îú‚îÄ‚îÄ Queue:        BullMQ + Redis 7 (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, CRON)
‚îú‚îÄ‚îÄ Cache:        Redis (Upstash ‚Äî serverless Redis)
‚îú‚îÄ‚îÄ Validation:   class-validator + class-transformer
‚îú‚îÄ‚îÄ Auth:         JWT RS256 (access 15min / refresh 30d HttpOnly cookie)
‚îú‚îÄ‚îÄ API Docs:     Swagger/OpenAPI 3.0 (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
‚îú‚îÄ‚îÄ Error:        RFC 7807 Problem Details
‚îî‚îÄ‚îÄ Deploy:       Fly.io (multi-region)

 apps/backend/src/
 ‚îú‚îÄ‚îÄ main.ts              ‚Üê API server (–ø–æ—Ä—Ç 3000)
 ‚îú‚îÄ‚îÄ worker.ts            ‚Üê BullMQ worker (–ø–æ—Ä—Ç 3001)
 ‚îú‚îÄ‚îÄ cron.ts              ‚Üê CRON scheduler (–ø–æ—Ä—Ç 3002)
 ‚îî‚îÄ‚îÄ modules/
     ‚îú‚îÄ‚îÄ auth/            ‚Üê JWT, Login, Register, Reset, MFA
     ‚îú‚îÄ‚îÄ users/           ‚Üê User management
     ‚îú‚îÄ‚îÄ tenants/         ‚Üê Multi-tenant logic
     ‚îú‚îÄ‚îÄ restaurants/     ‚Üê Restaurant management
     ‚îú‚îÄ‚îÄ guests/          ‚Üê Guest profiles, cards
     ‚îú‚îÄ‚îÄ loyalty/         ‚Üê Loyalty Engine + Builder
     ‚îú‚îÄ‚îÄ subscriptions/   ‚Üê Billing, Plans
     ‚îú‚îÄ‚îÄ analytics/       ‚Üê Reports, snapshots
     ‚îú‚îÄ‚îÄ pos-integration/ ‚Üê iiko, R-Keeper adapters
     ‚îú‚îÄ‚îÄ telegram/        ‚Üê Bot webhooks, Mini App auth
     ‚îú‚îÄ‚îÄ notifications/   ‚Üê Email, SMS, Telegram, Push
     ‚îî‚îÄ‚îÄ activity-log/    ‚Üê Audit trail
```

**–ü–æ—á–µ–º—É NestJS?**  
Dependency Injection –∏–∑ –∫–æ—Ä–æ–±–∫–∏, –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è Guards/Interceptors/Pipes –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è RBAC.  
–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –±–µ–∑ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

**–ü–æ—á–µ–º—É Prisma?**  
Type-safe –∑–∞–ø—Ä–æ—Å—ã –∏—Å–∫–ª—é—á–∞—é—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏. –ú–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `prisma migrate`.  
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º.

### Frontend (Admin Panel)

```
Next.js 14 App Router + TypeScript
‚îú‚îÄ‚îÄ UI:        shadcn/ui + Radix UI (accessibility –∏–∑ –∫–æ—Ä–æ–±–∫–∏)
‚îú‚îÄ‚îÄ Styles:    Tailwind CSS 3 + CSS Variables (dark design system)
‚îú‚îÄ‚îÄ State:     Zustand (–≥–ª–æ–±–∞–ª—å–Ω—ã–π) + TanStack Query (server state)
‚îú‚îÄ‚îÄ Charts:    Recharts + tremor
‚îú‚îÄ‚îÄ Real-time: Server-Sent Events (SSE)
‚îú‚îÄ‚îÄ Forms:     React Hook Form + Zod
‚îú‚îÄ‚îÄ Tables:    TanStack Table
‚îî‚îÄ‚îÄ Deploy:    Vercel (Edge Network)
```

### Frontend (Cashier POS)

```
Next.js 14 (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: pos.maxloyalty.app)
‚îú‚îÄ‚îÄ Touch-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (target 48px+)
‚îú‚îÄ‚îÄ PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (NumPad UI)
‚îú‚îÄ‚îÄ Offline: IndexedDB (Dexie.js)
‚îú‚îÄ‚îÄ Thermal print: ESCPOS –∫–æ–º–∞–Ω–¥—ã + fallback browser.print()
‚îî‚îÄ‚îÄ Search: debounce 200ms, barcode scanner –ø–æ–¥–¥–µ—Ä–∂–∫–∞
```

### Telegram

```
Telegraf 4 (Telegram Bot framework)
‚îú‚îÄ‚îÄ Webhook —Ä–µ–∂–∏–º (production)
‚îú‚îÄ‚îÄ Long polling (development)
‚îú‚îÄ‚îÄ Scenes: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ø–æ–¥–¥–µ—Ä–∂–∫–∞
‚îî‚îÄ‚îÄ Mini App: React + Vite + Telegram Web App SDK
    ‚îú‚îÄ‚îÄ Auth: HMAC-SHA256 initData ‚Üí JWT
    ‚îî‚îÄ‚îÄ Deploy: Vercel / Cloudflare Pages
```

### POS Plugins

```
iiko Front Plugin:
‚îú‚îÄ‚îÄ C# .NET 4.7.2 WPF
‚îú‚îÄ‚îÄ IFrontPlugin –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îú‚îÄ‚îÄ Polly (retry policy)
‚îú‚îÄ‚îÄ OfflineQueueService (JSON —Ñ–∞–π–ª, max 100 ops, TTL 24—á)
‚îî‚îÄ‚îÄ Auto-update —á–µ—Ä–µ–∑ URL

R-Keeper Plugin:
‚îú‚îÄ‚îÄ MaxLoyaltyRKeeper.dll (C++ Native External DLL)
‚îú‚îÄ‚îÄ MaxLoyaltyRKeeperUI.exe (C# WPF)
‚îú‚îÄ‚îÄ Shared Memory (Memory-Mapped File, 1 MB JSON)
‚îî‚îÄ‚îÄ FarCard protocol
```

### Infrastructure

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Production Stack                     ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  Backend API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Fly.io (Frankfurt, Singapore)    ‚îÇ
‚îÇ  Frontend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Vercel (Edge Network)             ‚îÇ
‚îÇ  PostgreSQL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Neon.tech (serverless, auto-scale)‚îÇ
‚îÇ  Redis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Upstash (serverless, multi-region)‚îÇ
‚îÇ  Storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Cloudflare R2 (S3-compatible)     ‚îÇ
‚îÇ  CDN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Cloudflare                        ‚îÇ
‚îÇ  Monitoring ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Prometheus + Grafana              ‚îÇ
‚îÇ  Error tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Sentry                            ‚îÇ
‚îÇ  Logs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ELK Stack / BetterStack           ‚îÇ
‚îÇ  CI/CD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ GitHub Actions                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—É—Ç–∏

### 8.1 –ü—É—Ç—å –Ω–æ–≤–æ–≥–æ Admin (Owner ‚Üí RestaurantAdmin)

```
1. Owner —Å–æ–∑–¥–∞—ë—Ç OwnerRegistrationLink (—Å —Ç–æ–∫–µ–Ω–æ–º, —Å—Ä–æ–∫ 48—á)
2. Admin –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ, –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É:
   email, name, phone, password (8+)
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email (24—á)
4. Admin –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ ‚Üí –æ–ø–ª–∞—Ç–∞
5. –°–æ–∑–¥–∞—ë—Ç—Å—è: Tenant + Subscription + User(RESTAURANT_ADMIN)
6. Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω:
   a. –ó–∞–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
   b. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç LoyaltySystem (UNIFIED/SEPARATE, POINTS/DISCOUNT)
   c. –°–æ–∑–¥–∞—ë—Ç —É—Ä–æ–≤–Ω–∏ (Bronze/Silver/Gold)
   d. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
   e. –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–∏
   f. –ö–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É–µ—Ç –¥–∏–∑–∞–π–Ω –∫–∞—Ä—Ç—ã
   g. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç POS (API Key + –ø–ª–∞–≥–∏–Ω)
   h. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç Telegram-–±–æ—Ç–∞
7. –°–æ–∑–¥–∞—ë—Ç Cashier-–∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤
8. –ó–∞–ø—É—Å–∫! üöÄ
```

### 8.2 –ü—É—Ç—å –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ –∫–∞—Å—Å–∏—Ä–∞**
```
1. –ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç—è"
2. –í–≤–æ–¥–∏—Ç: —Ç–µ–ª–µ—Ñ–æ–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ), –∏–º—è, —Ñ–∞–º–∏–ª–∏—è, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
3. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
4. –°–æ–∑–¥–∞—ë—Ç—Å—è: User + GuestProfile + GuestCard (—Å QR –∏ 6-digit –∫–æ–¥–æ–º)
5. Welcome promo –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω FirstVisit)
6. –ö–∞—Å—Å–∏—Ä –ø–µ—á–∞—Ç–∞–µ—Ç –∫–∞—Ä—Ç—É –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç QR –Ω–∞ —ç–∫—Ä–∞–Ω–µ
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ QR-—Å—Å—ã–ª–∫–µ**
```
1. Admin —Å–æ–∑–¥–∞—ë—Ç QR-–∫–æ–¥ (—Å—Å—ã–ª–∫–∞ —Å restaurantId)
2. –ì–æ—Å—Ç—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
3. –ó–∞–ø–æ–ª–Ω—è–µ—Ç: —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ email)
4. SMS/Telegram –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
5. –°–æ–∑–¥–∞—ë—Ç—Å—è: User + GuestProfile + GuestCard
6. –†–µ–¥–∏—Ä–µ–∫—Ç –≤ Telegram Mini App (–µ—Å–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω –±–æ—Ç)
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞**
```
1. Admin –¥–µ–ª–∏—Ç—Å—è —Å—Å—ã–ª–∫–æ–π @restaurantloyaltybot
2. –ì–æ—Å—Ç—å –ø–∏—à–µ—Ç /start (–∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ deep link)
3. –ë–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (Telegram share button)
4. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω?
   a. –î–ê ‚Üí –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç Telegram ID –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É GuestProfile
   b. –ù–ï–¢ ‚Üí –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–º—è –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è ‚Üí —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Ñ–∏–ª—å
5. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Mini App —Å –∫–∞—Ä—Ç–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
```

### 8.3 –ü—É—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (Earn —á–µ—Ä–µ–∑ POS)

```
–ì–æ—Å—Ç—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ–∫ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ:
    ‚Üì
POS-—Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Webhook POST /api/pos/webhooks/transaction
{
  restaurantPosUnitId: "rest-001",
  posCheckId: "CHK-123456",
  guestPhone: "+79991234567",  // –∏–ª–∏ posGuestId
  checkAmount: 2000,
  items: [...],
  timestamp: "2026-02-20T12:00:00Z"
}
    ‚Üì
HMAC-SHA256 –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏
    ‚Üì
Idempotency check (tenantId + posCheckId = UNIQUE)
    ‚Üì
Loyalty Engine: calculate earnings
‚îú‚îÄ‚îÄ –ù–∞–π—Ç–∏ GuestCard –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
‚îú‚îÄ‚îÄ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
‚îú‚îÄ‚îÄ –£—á–µ—Å—Ç—å —É—Ä–æ–≤–Ω–µ–≤—ã–π –±–æ–Ω—É—Å
‚îî‚îÄ‚îÄ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ (—Å conflict resolution)
    ‚Üì
DB Transaction (–∞—Ç–æ–º–∞—Ä–Ω–æ):
‚îú‚îÄ‚îÄ INSERT BallTransaction(type=EARN, amount=300)
‚îú‚îÄ‚îÄ INSERT GuestVisit
‚îú‚îÄ‚îÄ INSERT POSTransaction
‚îú‚îÄ‚îÄ UPDATE GuestCard(balance += 300, lifetimeSpent += 2000)
‚îî‚îÄ‚îÄ INSERT ActivityLog
    ‚Üì
Redis cache invalidation (guestBalance:cardId)
    ‚Üì
Notification job ‚Üí BullMQ (Telegram: "–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ 300 –±–∞–ª–ª–æ–≤!")
    ‚Üì
Webhook response: 200 OK { success: true, earned: 300, balance: 2500 }
```

---

## 9. –ö–ª—é—á–µ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 9.1 Auth Flow (–∫—Ä–∞—Ç–∫–∏–π)

```
Register:  email+phone+password ‚Üí bcrypt(cost=12) ‚Üí email verification ‚Üí JWT
Login:     email/phone + password ‚Üí rate limit (5/15min) ‚Üí bcrypt check
           ‚Üí [optional MFA TOTP] ‚Üí Access Token (15min) + Refresh Cookie (30d)
Refresh:   HttpOnly Cookie ‚Üí blacklist check ‚Üí new Access Token
Logout:    refresh token ‚Üí Redis blacklist ‚Üí clear cookie
Logout-All: –≤—Å–µ refresh tokens ‚Üí blacklist
```

### 9.2 POS Integration Flow (PUSH + PULL)

```
PUSH (Webhook):     POS ‚Üí POST /api/pos/webhooks/transaction
PULL (Polling):     Backend ‚Üí GET iiko/api/guests?since=lastSyncTime (–∫–∞–∂–¥—ã–µ 30–º–∏–Ω)
Reconciliation:     CRON ‚Üí —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç POS.balls —Å backend.BallTransaction ‚Üí alert –ø—Ä–∏ >1% —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏
Offline fallback:   CSV-–∏–º–ø–æ—Ä—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
```

### 9.3 Analytics Data Flow

```
Real-time data:   BallTransaction + GuestVisit + POSTransaction
    ‚Üì (CRON 02:00)
AnalyticsDailySnapshot (–ø–æ —Ç–µ–Ω–∞–Ω—Ç—É + —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É)
    ‚Üì (CRON 01:00 –≤ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞)
AnalyticsMonthlySnapshot
    ‚Üì
GuestSegmentation: RFM-–∞–Ω–∞–ª–∏–∑ (Champions / Loyal / At Risk / Lost)
    ‚Üì
Dashboards: Owner / Admin / Manager (—á–µ—Ä–µ–∑ API —Å Redis –∫—ç—à–µ–º 5 –º–∏–Ω)
```

---

## 10. –ì–ª–æ—Å—Å–∞—Ä–∏–π

| –¢–µ—Ä–º–∏–Ω | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |
|---|---|
| **Tenant** | –ö–ª–∏–µ–Ω—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–∞–∫–∫–∞—É–Ω—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞/—Å–µ—Ç–∏). –ò–º–µ–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏ –ª–∏–º–∏—Ç—ã. |
| **TenantId** | UUID-–∫–ª—é—á –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ –≤ pooled –ë–î |
| **GuestProfile** | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç—è (—Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è) |
| **GuestCard** | –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –≥–æ—Å—Ç—è (–±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–µ–Ω—å, QR-–∫–æ–¥) |
| **GuestChild** | –î–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—å (—Ä–µ–±—ë–Ω–æ–∫ –≥–æ—Å—Ç—è) –¥–ª—è –¥–µ—Ç—Å–∫–∏—Ö –ø—Ä–æ–º–æ |
| **regularBalance** | –ë–∞–ª–ª—ã, –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ–∫—É–ø–∫–∏ (–±–µ–∑ —Å—Ä–æ–∫–∞, –∫—Ä–æ–º–µ inactivity) |
| **promoBalance** | –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã –æ—Ç –ø—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–π (—Å `expiresAt`) |
| **lifetimeSpent** | –°—É–º–º–∞—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫ –≥–æ—Å—Ç—è (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —É—Ä–æ–≤–Ω—è) |
| **LoyaltySystem** | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞/—Å–µ—Ç–∏ |
| **LoyaltyRule** | –ü—Ä–∞–≤–∏–ª–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ (–ø—Ä–æ—Ü–µ–Ω—Ç + —É—Å–ª–æ–≤–∏—è) |
| **LoyaltyRuleVersion** | –°–Ω–∏–º–æ–∫ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∞–≤–∏–ª–∞ (–¥–ª—è –∞—É–¥–∏—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π) |
| **LoyaltyLevel** | –£—Ä–æ–≤–µ–Ω—å –≥–æ—Å—Ç—è (Bronze/Silver/Gold) —Å –ø–æ—Ä–æ–≥–æ–º –∏ –±–æ–Ω—É—Å–æ–º |
| **LoyaltyPromo** | –ü—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏—è (Birthday, FirstVisit, Inactivity –∏ —Ç.–¥.) |
| **PromoBallGranted** | –ó–∞–ø–∏—Å—å –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ-–±–∞–ª–ª–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –≥–æ—Å—Ç—é |
| **BallTransaction** | –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (EARN/REDEEM/EXPIRE/etc.) |
| **GuestVisit** | –ó–∞–ø–∏—Å—å –æ –≤–∏–∑–∏—Ç–µ –≥–æ—Å—Ç—è –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω |
| **POSTransaction** | –ó–∞–ø–∏—Å—å –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –∫–∞—Å—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã |
| **POSGuestLink** | –°–≤—è–∑—å POS-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –≥–æ—Å—Ç—è —Å `GuestCard` |
| **UNIFIED** | –†–µ–∂–∏–º: –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∞ –¥–ª—è –≤—Å–µ–π —Å–µ—Ç–∏ |
| **SEPARATE** | –†–µ–∂–∏–º: –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –≤ –∫–∞–∂–¥–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ |
| **EARN** | –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∑–∞ –ø–æ–∫—É–ø–∫—É |
| **REDEEM** | –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –≤ —Å—á—ë—Ç –æ–ø–ª–∞—Ç—ã |
| **Impersonation** | –í—Ö–æ–¥ Owner'–∞ –ø–æ–¥ –≤–∏–¥–æ–º –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –ª–æ–≥–æ–º) |
| **ActivityLog** | –ê—É–¥–∏—Ç-–∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ |
| **TenantLimits** | –õ–∏–º–∏—Ç—ã —Ç–µ–Ω–∞–Ω—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–∞—Ä–∏—Ñ–Ω–æ–º—É –ø–ª–∞–Ω—É |
| **MRR** | Monthly Recurring Revenue ‚Äî –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –¥–æ—Ö–æ–¥ |
| **ARR** | Annual Recurring Revenue ‚Äî –≥–æ–¥–æ–≤–æ–π —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –¥–æ—Ö–æ–¥ |
| **Churn** | –û—Ç—Ç–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç —É—à–µ–¥—à–∏—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤ |
| **ARPU** | Average Revenue Per User ‚Äî —Å—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **LTV** | Lifetime Value ‚Äî –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ |
| **RFM** | Recency + Frequency + Monetary ‚Äî –º–µ—Ç–æ–¥ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –≥–æ—Å—Ç–µ–π |
| **Grace period** | –õ—å–≥–æ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (90 –¥–Ω–µ–π) –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ |
| **HMAC-SHA256** | –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏ webhook-–∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç POS |
| **FIFO** | First In First Out ‚Äî –ø–æ—Ä—è–¥–æ–∫ –∏—Å—Ç–µ—á–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ |
| **COMBINE_ALL** | –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–æ–º–æ: —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ |
| **MAX_ONLY** | –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–æ–º–æ: –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å |
| **FIRST_ONLY** | –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–æ–º–æ: –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–º–æ —Å –Ω–∞–∏–≤—ã—Å—à–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º |
| **idempotency** | –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å = —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç |

---

*‚Üê [README.md](../README.md) | ‚Üí [01_DATABASE_SCHEMA.md](./blocks/01_DATABASE_SCHEMA.md)*
